<Page x:Class="OSDPBench.Windows.Views.Pages.ConnectPage"
	  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
	  xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
	  xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
	  xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
	  xmlns:pages="clr-namespace:OSDPBench.Windows.Views.Pages"
	  xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
	  xmlns:converters="clr-namespace:OSDPBench.Windows.Converters"
	  xmlns:controls="clr-namespace:OSDPBench.Windows.Views.Controls"
	  xmlns:markup="clr-namespace:OSDPBench.Windows.Markup"
	  mc:Ignorable="d" 
	  d:DataContext="{d:DesignInstance pages:ConnectPage,
									 IsDesignTimeCreatable=False}"
	  d:DesignHeight="450" d:DesignWidth="800"
	  Title="{markup:Localize Page_Connect}">

    <Page.Resources>
        <converters:StatusLevelConverter x:Key="StatusLevelConverter" />
        <converters:StringToVisibilityConverter x:Key="StringToVisibilityConverter" />
        <converters:IndexToVisibilityConverter x:Key="IndexToVisibilityConverter" />
    </Page.Resources>

    <StackPanel Style="{StaticResource Page.Container}">
        <!-- Page Header with Activity Indicators -->
        <ContentControl Content="{Binding RelativeSource={RelativeSource AncestorType=Page}, Path=Title}"
                        Template="{StaticResource Template.PageHeader}"/>
        <Border Style="{StaticResource Card.Bordered}">
            <StackPanel Style="{StaticResource Card.Content}">
                <ui:TextBlock FontTypography="Subtitle"
                              Text="{markup:Localize Connect_SerialPortSelection}"
                              TextWrapping="Wrap"
                              Margin="0,0,0,10"/>
                <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="200"/>
                    <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>
                
                <!-- Serial Port Selection -->
                <StackPanel Grid.Column="0" Orientation="Vertical">
                    <Label Content="{markup:Localize Connect_SerialPort}"
                           Style="{StaticResource Label.Standard}"
                           Target="{Binding ElementName=SerialPortComboBox}" />
                    <ComboBox x:Name="SerialPortComboBox"
                              ItemsSource="{Binding ViewModel.AvailableSerialPorts }"
                              DisplayMemberPath="Name"
                              SelectedItem="{Binding ViewModel.SelectedSerialPort}"/>
                </StackPanel>
                
                <!-- USB Status Display -->
                <TextBlock Grid.Column="1"
                           Text="{Binding ViewModel.UsbStatusText}"
                           VerticalAlignment="Center"
                           Margin="10,0,0,0">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock" BasedOn="{StaticResource Text.Caption}">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Text, RelativeSource={RelativeSource Self}}" Value="">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>
            </Grid>
            </StackPanel>
        </Border>
        <Border Style="{StaticResource Card.Bordered}">
            <StackPanel Style="{StaticResource Card.Content}">
                <Grid Style="{StaticResource Style.ConnectionSection}">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto" />
                        <RowDefinition Height="Auto" />
                    </Grid.RowDefinitions>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="Auto" MinWidth="100" />
                    </Grid.ColumnDefinitions>
                    <ui:TextBlock FontTypography="Subtitle"
                                  Grid.Row="0"
                                  Grid.Column="0"
                                  Text="{markup:Localize Connect_ConnectToPD}"
                                  TextWrapping="Wrap"
                                  Margin="0,0,0,10"/>
                    <ui:TextBlock Style="{StaticResource Text.Caption}"
                                  Grid.Row="1"
                                  Grid.Column="0"
                                  Visibility="{Binding Path=ViewModel.StatusLevel, Converter={StaticResource StringToVisibilityConverter}, ConverterParameter=Connected, Mode=OneWay}"
                                  TextWrapping="Wrap">
                        <ui:TextBlock.Text>
                            <MultiBinding StringFormat="{markup:Localize Connection_DeviceConnectedFormat}">
                                <Binding Path="ViewModel.ConnectedAddress" />
                                <Binding Path="ViewModel.ConnectedBaudRate" />
                            </MultiBinding>
                        </ui:TextBlock.Text>
                    </ui:TextBlock>

                    <ComboBox Name="ConnectionTypeComboBox"
						Grid.Row="0"
						Grid.RowSpan="2"
						Grid.Column="1"
						Margin="0,0,16,0"
						ItemsSource="{Binding ConnectionTypes }"
						SelectedIndex="{Binding SelectedConnectionTypeIndex, Mode=TwoWay}"/>
                </Grid>
                
                <Grid 
					Visibility="{Binding ElementName=ConnectionTypeComboBox, Path=SelectedIndex, Converter={StaticResource IndexToVisibilityConverter}, ConverterParameter=0, Mode=OneWay}">
                    <StackPanel Orientation="Vertical">
                        <ui:TextBlock Style="{StaticResource Text.Body}"
							Margin="10 5"
							HorizontalAlignment="Center"
							Text="{markup:Localize Connect_DiscoveryWarning}" 
							TextWrapping="Wrap"/>
                        <StackPanel Orientation="Horizontal"
									HorizontalAlignment="Left">
                            <ui:Button  Content="{markup:Localize Connect_StartDiscovery}"
										Margin="10 5"
										HorizontalAlignment="Center"
										Command="{Binding ViewModel.DiscoverDeviceCommand}">
                                <ui:Button.Style>
                                    <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                                        <Setter Property="Visibility" Value="Visible"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding ViewModel.StatusLevel}" Value="Connected">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </ui:Button.Style>
                            </ui:Button>
                            <ui:Button  Content="{markup:Localize Connect_CancelDiscovery}"
										Margin="10 5"
										HorizontalAlignment="Center"
										Command="{Binding ViewModel.DiscoverDeviceCancelCommand}">
                                <ui:Button.Style>
                                    <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                                        <Setter Property="Visibility" Value="Visible"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding ViewModel.StatusLevel}" Value="Connected">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </ui:Button.Style>
                            </ui:Button>
                            <ui:Button  Content="{markup:Localize Connect_Disconnect}"
										Margin="10 5"
										HorizontalAlignment="Center"
										Command="{Binding ViewModel.DisconnectDeviceCommand}">
                                <ui:Button.Style>
                                    <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding ViewModel.StatusLevel}" Value="Connected">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </ui:Button.Style>
                            </ui:Button>
                        </StackPanel>
                    </StackPanel>
                </Grid>

                <Grid
					Visibility="{Binding ElementName=ConnectionTypeComboBox, Path=SelectedIndex, Converter={StaticResource IndexToVisibilityConverter}, ConverterParameter=1, Mode=OneWay}">
                    <StackPanel Orientation="Vertical">
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition />
                                <RowDefinition />
                            </Grid.RowDefinitions>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Row="0" Grid.Column="0" Orientation="Vertical">
                                <Label Content="{markup:Localize Connect_BaudRate}"
                                       Style="{StaticResource Label.Standard}"
										   Target="{Binding ElementName=BaudRateComboBox}" />
                                <ComboBox Name="BaudRateComboBox"
										  Margin="0 0 20 0"
                                          ItemsSource="{Binding ViewModel.AvailableBaudRates}"
                                          SelectedItem="{Binding  Path=ViewModel.SelectedBaudRate, Mode=TwoWay}"/>
                            </StackPanel>
                            <StackPanel Grid.Row="0" Grid.Column="1" Orientation="Vertical">
                                <Label Content="{markup:Localize Connect_Address}"
                                       Style="{StaticResource Label.Standard}"
										   Target="{Binding ElementName=AddressNumberBox}" />
                                <ui:NumberBox Name="AddressNumberBox"
											  Value="{Binding Path=ViewModel.SelectedAddress, Mode=TwoWay}"
											  TextChanged="AddressNumberBox_OnTextChanged"
											  ValueChanged="AddressNumberBox_OnValueChanged"
											  Margin="0 0 20 0"
                                              Minimum="0"
											  Maximum="127"
                                              ClearButtonEnabled="False"
											  MaxDecimalPlaces="0"/>
                            </StackPanel>
                            <StackPanel Grid.Row="1" Grid.Column="0" Grid.ColumnSpan="2" 
                                        Margin="0,5,0,0"
                                        Orientation="Vertical">
	                            <StackPanel Orientation="Horizontal">
		                            <CheckBox Name="UseSecureChannelCheckBox"
		                                      Content="{markup:Localize Connect_UseSecureChannel}" 
		                                      IsChecked="{Binding Path=ViewModel.UseSecureChannel,  Mode=TwoWay}"/>
		                            
		                            <CheckBox Name="UseDefaultKeyCheckBox"
		                                      Content="{markup:Localize Connect_UseDefaultKey}" 
		                                      Margin="10,0,0,0"
		                                      IsEnabled="{Binding ElementName=UseSecureChannelCheckBox, Path=IsChecked}"
		                                      IsChecked="{Binding  Path=ViewModel.UseDefaultKey,  Mode=TwoWay}"/>
	                            </StackPanel>
	                           
	                            <StackPanel Orientation="Vertical">
		                            <Label Content="{markup:Localize Connect_SecurityKey}"
		                                   Style="{StaticResource Label.Standard}"
		                                   Target="{Binding ElementName=AddressNumberBox}" />
                                    <TextBox Text="{Binding Path=ViewModel.SecurityKey,  Mode=TwoWay}">
                                        <TextBox.Style>
                                            <Style TargetType="TextBox" BasedOn="{StaticResource {x:Type TextBox}}">
                                                <!-- Only add the specific triggers needed -->
                                                <Setter Property="IsEnabled" Value="False"/>
                                                <Style.Triggers>
                                                    <MultiDataTrigger>
                                                        <MultiDataTrigger.Conditions>
                                                            <Condition Binding="{Binding ElementName=UseSecureChannelCheckBox, Path=IsChecked}" Value="True"/>
                                                            <Condition Binding="{Binding ElementName=UseDefaultKeyCheckBox, Path=IsChecked}" Value="False"/>
                                                        </MultiDataTrigger.Conditions>
                                                        <Setter Property="IsEnabled" Value="True"/>
                                                    </MultiDataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBox.Style>
                                    </TextBox>
                                </StackPanel>
                            </StackPanel>
                            
                            <ui:Button Grid.Row="1" Grid.Column="2"  Content="{markup:Localize Connect_Connect}"
                                       Margin="10 0"
                                       HorizontalAlignment="Right"
                                       VerticalAlignment="Bottom"
                                       Command="{Binding ViewModel.ConnectDeviceCommand}">
                                <ui:Button.Style>
                                    <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                                        <Setter Property="Visibility" Value="Visible"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding ViewModel.StatusLevel}" Value="Connected">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </ui:Button.Style>
                            </ui:Button>
                            <ui:Button Grid.Row="1" Grid.Column="2"  Content="{markup:Localize Connect_Disconnect}"
                                       Margin="10 0"
                                       HorizontalAlignment="Right"
                                       VerticalAlignment="Bottom"
                                       Command="{Binding ViewModel.DisconnectDeviceCommand}">
                                <ui:Button.Style>
                                    <Style TargetType="ui:Button" BasedOn="{StaticResource {x:Type ui:Button}}">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding ViewModel.StatusLevel}" Value="Connected">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </ui:Button.Style>
                            </ui:Button>
                        </Grid>
                    </StackPanel>
                </Grid>

                <TextBlock 
					Margin="10 5"
					HorizontalAlignment="Center"
					TextAlignment="Center"
					TextWrapping="Wrap"
					Foreground="{Binding ViewModel.StatusLevel, Converter={StaticResource StatusLevelConverter}}"
					Text="{Binding ViewModel.StatusText}">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock" BasedOn="{StaticResource Text.Title}">
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Text, RelativeSource={RelativeSource Self}}" Value="">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>
                <TextBlock 
					Margin="10 5"
					HorizontalAlignment="Center"
					TextAlignment="Center"
					TextWrapping="Wrap"
					Text="{Binding ViewModel.NakText}">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock" BasedOn="{StaticResource Text.Error}">
                            <Setter Property="FontSize" Value="{StaticResource FontSize.Title}"/>
                            <Setter Property="FontWeight" Value="Bold"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding Text, RelativeSource={RelativeSource Self}}" Value="">
                                    <Setter Property="Visibility" Value="Collapsed" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                </TextBlock>
            </StackPanel>
        </Border>
    </StackPanel>
</Page>
